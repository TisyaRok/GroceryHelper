<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GroceryHelper ‚Äî Smart Shopping Lists</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f5f0e8;
    --sage: #5a7a5e;
    --sage-light: #8aad8f;
    --sage-pale: #dde9df;
    --terracotta: #c1633a;
    --gold: #d4a853;
    --paper: #faf7f2;
    --border: #d8d0c0;
    --muted: #7a7468;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  header {
    background: var(--ink);
    color: var(--cream);
    padding: 0 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-leaf {
    width: 28px; height: 28px;
    background: var(--sage);
    border-radius: 60% 40% 60% 40%;
    transform: rotate(-30deg);
    display: inline-block;
  }

  .logo span { color: var(--sage-light); }

  /* ‚îÄ‚îÄ API KEY BAR ‚îÄ‚îÄ */
  .api-key-bar {
    background: #fffbf0;
    border-bottom: 1px solid #e8d580;
    padding: 0 48px;
    height: 44px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8rem;
  }

  .api-key-label {
    font-weight: 600;
    color: #7a6a30;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .api-key-input {
    flex: 1;
    max-width: 380px;
    padding: 5px 10px;
    border: 1.5px solid #e8d580;
    border-radius: 7px;
    font-family: 'DM Sans', monospace;
    font-size: 0.8rem;
    background: white;
    outline: none;
    color: var(--ink);
    transition: border-color 0.2s;
  }

  .api-key-input:focus { border-color: var(--gold); }

  .api-key-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 3px 9px;
    border-radius: 20px;
  }

  .api-key-status.ok { background: var(--sage-pale); color: var(--sage); }
  .api-key-status.missing { background: #fef0eb; color: var(--terracotta); }

  .api-key-hint {
    color: var(--muted);
    font-size: 0.75rem;
  }

  .api-key-hint a { color: var(--gold); text-decoration: none; }
  .api-key-hint a:hover { text-decoration: underline; }

  nav { display: flex; gap: 32px; }
  nav a {
    color: rgba(245,240,232,0.65);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.3px;
    transition: color 0.2s;
  }
  nav a:hover, nav a.active { color: var(--cream); }

  main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 40px 48px 80px;
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 32px;
  }

  .hero {
    grid-column: 1 / -1;
    background: var(--sage);
    border-radius: 16px;
    padding: 36px 48px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  .hero::after {
    content: 'ü•¶ü•ïüßÖü´ëü•¨üçã';
    position: absolute;
    right: 160px;
    font-size: 3.5rem;
    opacity: 0.22;
    letter-spacing: 8px;
    pointer-events: none;
    top: 50%;
    transform: translateY(-50%);
  }

  .hero-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 900;
    color: white;
    line-height: 1.1;
    margin-bottom: 8px;
  }

  .hero-text p {
    color: rgba(255,255,255,0.78);
    font-size: 0.95rem;
    font-weight: 300;
    max-width: 420px;
  }

  .hero-stats { display: flex; gap: 32px; z-index: 1; }

  .stat {
    text-align: center;
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 14px 20px;
    backdrop-filter: blur(4px);
  }

  .stat-num {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    color: white;
    line-height: 1;
  }

  .stat-label {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .card {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }

  .card-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  .card-body { padding: 20px 24px; }

  /* ‚îÄ‚îÄ RECIPE SEARCH ‚îÄ‚îÄ */
  .search-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .search-input {
    flex: 1;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    color: var(--ink);
    background: white;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--sage); }
  .search-input::placeholder { color: var(--muted); }

  .btn-add-recipe {
    padding: 10px 18px;
    background: var(--sage);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-add-recipe:hover { background: #4a6a4e; transform: translateY(-1px); }
  .btn-add-recipe:disabled { opacity: 0.5; pointer-events: none; }

  /* SUGGESTION CHIPS */
  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 14px;
  }

  .suggestion-chip {
    padding: 5px 12px;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .suggestion-chip:hover {
    border-color: var(--sage);
    color: var(--sage);
    background: var(--sage-pale);
  }

  /* RECIPE CARDS */
  .recipe-list { display: flex; flex-direction: column; gap: 8px; }

  .recipe-card {
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    background: white;
    position: relative;
    transition: all 0.2s;
  }

  .recipe-card.loading-card {
    border-color: var(--sage-pale);
    background: linear-gradient(90deg, #f0f4f1 25%, #e8ede9 50%, #f0f4f1 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .recipe-card.selected {
    border-color: var(--sage);
    background: var(--sage-pale);
  }

  .recipe-card.error-card {
    border-color: #f0b09a;
    background: #fff5f2;
  }

  .recipe-card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
  }

  .recipe-card-info { flex: 1; cursor: pointer; }

  .recipe-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 3px;
  }

  .recipe-meta {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .recipe-tag {
    display: inline-block;
    background: var(--sage-pale);
    color: var(--sage);
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 7px;
    border-radius: 4px;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .recipe-card-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toggle-btn {
    width: 22px; height: 22px;
    border-radius: 6px;
    border: 2px solid var(--border);
    background: white;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem;
    color: var(--sage);
    transition: all 0.15s;
    font-weight: 700;
  }

  .recipe-card.selected .toggle-btn {
    background: var(--sage);
    border-color: var(--sage);
    color: white;
  }

  .remove-btn {
    width: 22px; height: 22px;
    border-radius: 6px;
    border: 1.5px solid var(--border);
    background: white;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem;
    color: var(--muted);
    transition: all 0.15s;
  }

  .remove-btn:hover { border-color: var(--terracotta); color: var(--terracotta); }

  .ingredient-preview {
    margin-top: 8px;
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .api-badge {
    font-size: 0.65rem;
    background: #e8f4ea;
    color: var(--sage);
    border: 1px solid #b5d4b9;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }

  .loading-text {
    font-size: 0.8rem;
    color: var(--muted);
    padding: 8px 0;
  }

  /* ALLERGY */
  .allergy-section { margin-top: 8px; }
  .allergy-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 10px;
  }

  .allergy-pills { display: flex; flex-wrap: wrap; gap: 8px; }

  .pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
    user-select: none;
  }

  .pill:hover { border-color: var(--terracotta); }

  .pill.active {
    background: #fef0eb;
    border-color: var(--terracotta);
    color: var(--terracotta);
  }

  .pill-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--border);
  }
  .pill.active .pill-dot { background: var(--terracotta); }

  .btn-generate {
    width: 100%;
    padding: 16px;
    background: var(--ink);
    color: var(--cream);
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    cursor: pointer;
    transition: all 0.25s;
    margin-top: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .btn-generate:hover { background: var(--sage); transform: translateY(-1px); }

  .btn-generate.loading { opacity: 0.7; pointer-events: none; }

  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }

  .btn-generate.loading .spinner { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* SHOPPING LIST */
  .category-group { margin-bottom: 20px; }

  .category-name {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .ingredient-row {
    display: flex;
    align-items: center;
    padding: 9px 0;
    gap: 12px;
    border-bottom: 1px dashed rgba(0,0,0,0.07);
    animation: slideIn 0.3s ease forwards;
    opacity: 0;
    transform: translateX(-8px);
  }

  @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }

  .ing-check {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }

  .ing-check:hover { border-color: var(--sage); }
  .ing-check.checked { background: var(--sage); border-color: var(--sage); }
  .ing-check.checked::after { content: '‚úì'; color: white; font-size: 0.7rem; font-weight: 700; }

  .ing-name {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .ing-name.checked-text { text-decoration: line-through; color: var(--muted); }
  .ing-qty { font-size: 0.8rem; color: var(--muted); font-weight: 400; white-space: nowrap; }
  .ing-price { font-size: 0.82rem; font-weight: 600; color: var(--terracotta); min-width: 42px; text-align: right; }

  .consolidated-badge {
    font-size: 0.65rem;
    background: #fff8e1;
    color: #b5860d;
    border: 1px solid #e8d080;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    white-space: nowrap;
  }

  .allergen-flag {
    font-size: 0.65rem;
    background: #fef0eb;
    color: var(--terracotta);
    border: 1px solid #f0b09a;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }

  /* SIDEBAR */
  .sidebar { display: flex; flex-direction: column; gap: 24px; }

  .budget-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }

  .input-group label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  .input-group input, .input-group select {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    color: var(--ink);
    background: white;
    transition: border-color 0.2s;
    outline: none;
  }

  .input-group input:focus, .input-group select:focus { border-color: var(--sage); }

  .budget-bar-wrap { background: var(--border); border-radius: 6px; height: 10px; overflow: hidden; margin-bottom: 8px; }

  .budget-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--sage), var(--gold));
    border-radius: 6px;
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    width: 0%;
  }

  .budget-bar.over { background: linear-gradient(90deg, var(--gold), var(--terracotta)); }

  .budget-labels { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--muted); }
  .budget-labels strong { color: var(--ink); }

  .chart-wrap { position: relative; height: 180px; margin-top: 8px; }

  .fuzzy-item {
    background: #fffbf0;
    border: 1px solid #e8d580;
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 8px;
    font-size: 0.82rem;
    animation: fadeIn 0.4s ease forwards;
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  .fuzzy-arrow { color: var(--gold); margin: 0 6px; font-weight: 700; }
  .fuzzy-score { float: right; font-size: 0.7rem; font-weight: 600; color: var(--muted); background: #fef0c0; padding: 2px 6px; border-radius: 4px; }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.9rem; }

  .perf-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--sage-pale);
    border: 1px solid #b5d4b9;
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.8rem;
    color: var(--sage);
    font-weight: 500;
    margin-top: 12px;
  }

  .perf-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--sage);
    animation: pulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }

  .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 16px; }

  .tab {
    padding: 8px 16px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
  }

  .tab:hover { color: var(--ink); }
  .tab.active { color: var(--ink); border-bottom-color: var(--ink); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 14px 0;
  }

  @media (max-width: 900px) {
    main { grid-template-columns: 1fr; padding: 20px; }
    .hero { flex-direction: column; gap: 20px; }
    .hero-stats { gap: 12px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-leaf"></span>
    Grocery<span>Helper</span>
  </div>
  <nav>
    <a href="#" class="active">List Builder</a>
    <a href="#">Pantry</a>
    <a href="#">History</a>
    <a href="#">Settings</a>
  </nav>
</header>

<!-- API KEY BAR -->
<div class="api-key-bar">
  <span class="api-key-label">üîë Gemini API Key</span>
  <input
    type="password"
    class="api-key-input"
    id="api-key-input"
    placeholder="Paste your Google Gemini API key here (stays in-browser only)"
    oninput="updateKeyStatus()"
    autocomplete="off"
  />
  <span class="api-key-status missing" id="key-status">Not set</span>
  <span class="api-key-hint">Get one free at <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a></span>
</div>

<main>

  <div class="hero">
    <div class="hero-text">
      <h1>Smart lists.<br>Zero waste.</h1>
      <p>Search any recipe, and AI will fetch its ingredients in real time ‚Äî with consolidation, allergy filtering, and budget optimization built in.</p>
    </div>
    <div class="hero-stats">
      <div class="stat">
        <div class="stat-num">Any</div>
        <div class="stat-label">Recipe</div>
      </div>
      <div class="stat">
        <div class="stat-num">AI</div>
        <div class="stat-label">Powered</div>
      </div>
      <div class="stat">
        <div class="stat-num">Live</div>
        <div class="stat-label">Ingredients</div>
      </div>
    </div>
  </div>

  <!-- LEFT -->
  <div>
    <div class="card" style="margin-bottom:24px;">
      <div class="card-header">
        <div class="card-title">Add Recipes</div>
        <span style="font-size:0.8rem;color:var(--muted);" id="recipe-count">0 selected</span>
      </div>
      <div class="card-body">

        <!-- Search row -->
        <div class="search-row">
          <input
            type="text"
            class="search-input"
            id="recipe-search"
            placeholder="e.g. Thai Green Curry, Shakshuka, Beef Bourguignon‚Ä¶"
            onkeydown="if(event.key==='Enter') addRecipe()"
          />
          <button class="btn-add-recipe" id="add-btn" onclick="addRecipe()">
            <span id="add-spinner" style="display:none;width:14px;height:14px;border:2px solid rgba(255,255,255,0.4);border-top-color:white;border-radius:50%;animation:spin 0.7s linear infinite;"></span>
            <span id="add-text">+ Add</span>
          </button>
        </div>

        <!-- Suggestion chips -->
        <div class="suggestions" id="suggestions"></div>

        <!-- Recipe list -->
        <div class="recipe-list" id="recipe-list">
          <div style="text-align:center;padding:20px;color:var(--muted);font-size:0.85rem;">
            Search for a recipe above, or click a suggestion to get started
          </div>
        </div>

        <div class="divider"></div>

        <!-- Allergens -->
        <div class="allergy-section">
          <div class="allergy-label">Dietary Restrictions & Allergens</div>
          <div class="allergy-pills" id="allergy-pills"></div>
        </div>

        <button class="btn-generate" id="gen-btn" onclick="generateList()">
          <span class="spinner" id="spinner"></span>
          <span id="btn-text">‚ú¶ Generate Shopping List</span>
        </button>
      </div>
    </div>

    <!-- SHOPPING LIST -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Shopping List</div>
        <span style="font-size:0.8rem;color:var(--muted);" id="item-count">‚Äî</span>
      </div>
      <div class="card-body">
        <div id="shopping-list">
          <div class="empty-state">
            <div class="emoji">üõí</div>
            <p>Add recipes above and click<br><strong>Generate Shopping List</strong></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">

    <div class="card">
      <div class="card-header">
        <div class="card-title">Budget Optimizer</div>
      </div>
      <div class="card-body">
        <div class="budget-inputs">
          <div class="input-group">
            <label>Weekly Budget</label>
            <input type="number" id="budget-input" value="80" min="10" max="500">
          </div>
          <div class="input-group">
            <label>Preference</label>
            <select id="pref-select">
              <option value="value">Best Value</option>
              <option value="organic">Organic First</option>
              <option value="local">Local / Seasonal</option>
            </select>
          </div>
        </div>
        <div id="budget-display" style="display:none;">
          <div class="budget-bar-wrap">
            <div class="budget-bar" id="budget-bar"></div>
          </div>
          <div class="budget-labels">
            <span>Spent: <strong id="spent-label">$0</strong></span>
            <span>Budget: <strong id="budget-label">$80</strong></span>
          </div>
          <div class="chart-wrap">
            <canvas id="budget-chart"></canvas>
          </div>
        </div>
        <div id="budget-empty" style="text-align:center;padding:16px 0;color:var(--muted);font-size:0.85rem;">
          Generate a list to see budget breakdown
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Fuzzy Consolidations</div>
      </div>
      <div class="card-body">
        <div id="fuzzy-panel">
          <div class="empty-state" style="padding:24px 0;">
            <div class="emoji" style="font-size:2rem;">üîç</div>
            <p style="font-size:0.8rem;">Duplicate ingredients across recipes will be shown here</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Algorithm Notes</div>
      </div>
      <div class="card-body">
        <div class="tabs">
          <div class="tab active" onclick="switchTab(this,'algo')">Optimization</div>
          <div class="tab" onclick="switchTab(this,'filter')">Allergy Filter</div>
          <div class="tab" onclick="switchTab(this,'api')">API Layer</div>
        </div>
        <div id="algo" class="tab-panel active">
          <p style="font-size:0.82rem;line-height:1.6;color:#444;">
            Budget optimizer scores each ingredient by <strong>price-per-unit</strong>, weights user preference (organic, local), and uses a greedy algorithm to maximize value within the budget constraint. Quantity normalization converts all units before scoring.
          </p>
          <div class="perf-bar">
            <div class="perf-dot"></div>
            Any recipe ¬∑ Live ingredients ¬∑ Real-time optimization
          </div>
        </div>
        <div id="filter" class="tab-panel">
          <p style="font-size:0.82rem;line-height:1.6;color:#444;">
            Allergens are stored in a JavaScript <strong>Set</strong>, enabling O(1) hash map lookups per ingredient token. Ingredient names are tokenized and each token is tested against the allergen set ‚Äî flagging, not removing, items so users retain full visibility.
          </p>
          <div class="perf-bar">
            <div class="perf-dot"></div>
            O(1) per lookup ¬∑ O(n) total list traversal
          </div>
        </div>
        <div id="api" class="tab-panel">
          <p style="font-size:0.82rem;line-height:1.6;color:#444;">
            Recipe ingredients are fetched live from the <strong>Google Gemini API</strong> (gemini-2.0-flash). A structured JSON prompt with <code>responseMimeType: "application/json"</code> guarantees clean output ‚Äî no parsing hacks needed. Your key is never stored or sent anywhere except Google.
          </p>
          <div class="perf-bar">
            <div class="perf-dot"></div>
            Gemini 2.0 Flash ¬∑ Structured JSON mode ¬∑ Any recipe worldwide
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUGGESTIONS = [
  "Chicken Stir Fry","Pasta Primavera","Beef Tacos","Greek Salad",
  "Banana Bread","Lemon Salmon","Shakshuka","Thai Green Curry",
  "Mushroom Risotto","Beef Bourguignon"
];

const ALLERGENS = ["gluten","dairy","nuts","eggs","shellfish","soy","fish"];

const ALLERGEN_MAP = {
  gluten:  ["flour","wheat","pasta","bread","taco shells","soy sauce","baking soda","tortilla","crumb","cracker","oat","barley","rye"],
  dairy:   ["cheese","butter","cream","milk","parmesan","feta","sour cream","shredded cheese","yogurt","ricotta","mozzarella","brie","cheddar"],
  nuts:    ["almond","peanut","walnut","cashew","sesame","pecan","pistachio","hazelnut","macadamia","tahini"],
  eggs:    ["egg","eggs","mayonnaise","mayo"],
  shellfish:["shrimp","crab","lobster","clam","scallop","oyster","mussel","prawn"],
  soy:     ["soy sauce","tofu","edamame","miso","tempeh","soya"],
  fish:    ["salmon","tuna","anchovy","fish","cod","tilapia","halibut","bass","trout","sardine"],
};

// { id, name, servings, time, tag, ingredients: [{name, qty, price, cat}], selected: bool }
let recipes = [];
let selectedAllergens = new Set();
let budgetChart = null;
let recipeIdCounter = 0;

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  renderSuggestions();
  renderAllergyPills();
}

function renderSuggestions() {
  document.getElementById('suggestions').innerHTML = SUGGESTIONS.map(s =>
    `<div class="suggestion-chip" onclick="searchAndAdd('${s}')">${s}</div>`
  ).join('');
}

function renderAllergyPills() {
  document.getElementById('allergy-pills').innerHTML = ALLERGENS.map(a =>
    `<div class="pill" id="pill-${a}" onclick="toggleAllergen('${a}')">
      <span class="pill-dot"></span>${a.charAt(0).toUpperCase()+a.slice(1)}
    </div>`
  ).join('');
}

function toggleAllergen(a) {
  if (selectedAllergens.has(a)) selectedAllergens.delete(a);
  else selectedAllergens.add(a);
  document.getElementById(`pill-${a}`).classList.toggle('active');
}

function switchTab(el, id) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(id).classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ RECIPE ADD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchAndAdd(name) {
  document.getElementById('recipe-search').value = name;
  await addRecipe();
}

async function addRecipe() {
  const input = document.getElementById('recipe-search');
  const name = input.value.trim();
  if (!name) return;

  if (!getApiKey()) {
    alert('Please paste your Gemini API key in the bar at the top first. Get a free key at: https://aistudio.google.com/app/apikey');
    document.getElementById('api-key-input').focus();
    return;
  }

  // Check for duplicate
  if (recipes.find(r => r.name.toLowerCase() === name.toLowerCase())) {
    input.value = '';
    return;
  }

  // Set loading state
  const addBtn = document.getElementById('add-btn');
  const addSpinner = document.getElementById('add-spinner');
  const addText = document.getElementById('add-text');
  addBtn.disabled = true;
  addSpinner.style.display = 'block';
  addText.textContent = 'Fetching‚Ä¶';

  const tempId = ++recipeIdCounter;

  // Add placeholder card
  recipes.push({ id: tempId, name, loading: true, selected: false, ingredients: [] });
  renderRecipeList();
  input.value = '';

  try {
    const ingredients = await fetchIngredients(name);
    const recipeIdx = recipes.findIndex(r => r.id === tempId);
    if (recipeIdx !== -1) {
      recipes[recipeIdx] = {
        id: tempId,
        name,
        loading: false,
        selected: true,
        servings: ingredients.servings || 4,
        time: ingredients.cookTime || '30 min',
        tag: ingredients.tag || 'Recipe',
        ingredients: ingredients.items
      };
    }
  } catch (err) {
    const recipeIdx = recipes.findIndex(r => r.id === tempId);
    if (recipeIdx !== -1) {
      recipes[recipeIdx].loading = false;
      recipes[recipeIdx].error = true;
      recipes[recipeIdx].errorMsg = err.message;
    }
    console.error('Failed to fetch recipe:', err);
  }

  renderRecipeList();
  updateRecipeCount();

  addBtn.disabled = false;
  addSpinner.style.display = 'none';
  addText.textContent = '+ Add';
}

// ‚îÄ‚îÄ‚îÄ GOOGLE GEMINI API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getApiKey() {
  return document.getElementById('api-key-input').value.trim();
}

function updateKeyStatus() {
  const key = getApiKey();
  const el = document.getElementById('key-status');
  if (key.length > 10) {
    el.textContent = '‚úì Key set';
    el.className = 'api-key-status ok';
  } else {
    el.textContent = 'Not set';
    el.className = 'api-key-status missing';
  }
}

async function fetchIngredients(recipeName) {
  const apiKey = getApiKey();
  if (!apiKey) throw new Error('No API key set');

  const prompt = `You are a culinary assistant. Return ingredient data for "${recipeName}" as valid JSON only.
Do NOT include any markdown, code fences, backticks, or explanation ‚Äî just the raw JSON object.

Required schema:
{
  "servings": 4,
  "cookTime": "30 min",
  "tag": "Quick",
  "items": [
    { "name": "chicken breast", "qty": "1.5 lbs", "price": 7.49, "cat": "Meat & Seafood" }
  ]
}

Rules:
- tag must be one of: Quick, Vegetarian, Vegan, Healthy, Baking, Seafood, Family Fav, Spicy, Comfort
- cat must be one of: Produce, Meat & Seafood, Dairy, Pantry, Frozen, Bakery
- price is a number (USD), name is lowercase
- Include 6 to 12 ingredients
- Output ONLY the JSON, nothing else`;

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    }
  );

  if (!response.ok) {
    const errData = await response.json().catch(() => ({}));
    const msg = errData?.error?.message || `HTTP ${response.status}`;
    throw new Error(msg);
  }

  const data = await response.json();
  const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  // Strip any accidental markdown fences
  const clean = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/, '').trim();
  return JSON.parse(clean);
}

// ‚îÄ‚îÄ‚îÄ RENDER RECIPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecipeList() {
  const list = document.getElementById('recipe-list');

  if (recipes.length === 0) {
    list.innerHTML = `<div style="text-align:center;padding:20px;color:var(--muted);font-size:0.85rem;">Search for a recipe above, or click a suggestion to get started</div>`;
    return;
  }

  list.innerHTML = recipes.map(r => {
    if (r.loading) {
      return `<div class="recipe-card loading-card">
        <div class="loading-text">‚ü≥ Fetching ingredients for "${r.name}"‚Ä¶</div>
      </div>`;
    }
    if (r.error) {
      return `<div class="recipe-card error-card">
        <div class="recipe-card-top">
          <div class="recipe-card-info">
            <div class="recipe-name">${r.name}</div>
            <div class="recipe-meta" style="color:var(--terracotta);margin-bottom:4px;">‚ö† Failed to load</div>
            <div style="font-size:0.75rem;color:#b04020;background:#fde8e0;padding:4px 8px;border-radius:5px;font-family:monospace;">${r.errorMsg || 'Unknown error ‚Äî check browser console'}</div>
          </div>
          <button class="remove-btn" onclick="removeRecipe(${r.id})" title="Remove">‚úï</button>
        </div>
      </div>`;
    }

    const preview = r.ingredients.slice(0, 5).map(i => i.name).join(', ');
    return `<div class="recipe-card ${r.selected ? 'selected' : ''}" id="rcard-${r.id}">
      <div class="recipe-card-top">
        <div class="recipe-card-info" onclick="toggleRecipe(${r.id})">
          <div class="recipe-name">${r.name}</div>
          <div class="recipe-meta">${r.servings} servings ¬∑ ${r.time} ¬∑ ${r.ingredients.length} ingredients</div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
            <span class="recipe-tag">${r.tag}</span>
            <span class="api-badge">AI fetched</span>
          </div>
        </div>
        <div class="recipe-card-actions">
          <div class="toggle-btn" onclick="toggleRecipe(${r.id})">${r.selected ? '‚úì' : '+'}</div>
          <button class="remove-btn" onclick="removeRecipe(${r.id})" title="Remove">‚úï</button>
        </div>
      </div>
      ${r.ingredients.length > 0 ? `<div class="ingredient-preview">${preview}${r.ingredients.length > 5 ? ` +${r.ingredients.length-5} more` : ''}</div>` : ''}
    </div>`;
  }).join('');
}

function toggleRecipe(id) {
  const r = recipes.find(r => r.id === id);
  if (!r || r.loading || r.error) return;
  r.selected = !r.selected;
  renderRecipeList();
  updateRecipeCount();
}

function removeRecipe(id) {
  recipes = recipes.filter(r => r.id !== id);
  renderRecipeList();
  updateRecipeCount();
}

function updateRecipeCount() {
  const sel = recipes.filter(r => r.selected).length;
  document.getElementById('recipe-count').textContent = `${sel} selected`;
}

// ‚îÄ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateList() {
  const selected = recipes.filter(r => r.selected && !r.loading && !r.error);
  if (selected.length === 0) {
    alert('Please select at least one recipe first!');
    return;
  }

  const btn = document.getElementById('gen-btn');
  btn.classList.add('loading');
  document.getElementById('btn-text').textContent = 'Processing‚Ä¶';

  setTimeout(() => {
    processAndRender();
    btn.classList.remove('loading');
    document.getElementById('btn-text').textContent = '‚ú¶ Regenerate List';
  }, 600);
}

function processAndRender() {
  const selected = recipes.filter(r => r.selected && !r.loading && !r.error);
  const allIngredients = selected.flatMap(r => r.ingredients.map(i => ({...i})));

  // FUZZY CONSOLIDATION
  const consolidated = [];
  const fuzzyMatches = [];
  const used = new Set();

  for (let i = 0; i < allIngredients.length; i++) {
    if (used.has(i)) continue;
    let base = {...allIngredients[i]};
    let mergedWith = [];

    for (let j = i+1; j < allIngredients.length; j++) {
      if (used.has(j)) continue;
      const score = fuzzyScore(allIngredients[i].name, allIngredients[j].name);
      if (score >= 82) {
        mergedWith.push({name: allIngredients[j].name, score});
        base.price += allIngredients[j].price * 0.4;
        used.add(j);
      }
    }

    if (mergedWith.length > 0) {
      fuzzyMatches.push({from: allIngredients[i].name, into: mergedWith});
      base.consolidated = true;
    }

    used.add(i);
    consolidated.push(base);
  }

  // ALLERGEN FLAG
  const allergenSet = new Set(selectedAllergens);
  consolidated.forEach(ing => {
    ing.flagged = false;
    if (allergenSet.size === 0) return;
    const tokens = ing.name.toLowerCase().split(/[\s-]/);
    for (const [allergen, keywords] of Object.entries(ALLERGEN_MAP)) {
      if (!allergenSet.has(allergen)) continue;
      if (keywords.some(k => tokens.some(t => t.includes(k) || k.includes(t)))) {
        ing.flagged = true;
        ing.allergenType = allergen;
        break;
      }
    }
  });

  // BUDGET
  const budget = parseFloat(document.getElementById('budget-input').value) || 80;
  const pref = document.getElementById('pref-select').value;

  const scored = consolidated.map(ing => ({
    ...ing,
    score: ing.price * (pref === 'organic' ? 1.2 : 1)
  })).sort((a,b) => a.score - b.score);

  const totalCost = scored.reduce((s,i) => s + i.price, 0);

  renderShoppingList(scored);
  renderFuzzy(fuzzyMatches);
  renderBudget(totalCost, budget, scored);
}

function fuzzyScore(a, b) {
  a = a.toLowerCase().replace(/[^a-z ]/g,'').trim();
  b = b.toLowerCase().replace(/[^a-z ]/g,'').trim();
  if (a === b) return 100;
  const tokensA = new Set(a.split(' '));
  const tokensB = new Set(b.split(' '));
  const intersection = [...tokensA].filter(t => tokensB.has(t)).length;
  const union = new Set([...tokensA, ...tokensB]).size;
  const jaccard = intersection / union;
  const lenRatio = 1 - Math.abs(a.length - b.length) / Math.max(a.length, b.length, 1);
  return Math.round((jaccard * 0.7 + lenRatio * 0.3) * 100);
}

function renderShoppingList(items) {
  const cats = {};
  items.forEach(i => {
    if (!cats[i.cat]) cats[i.cat] = [];
    cats[i.cat].push(i);
  });

  const catOrder = ["Produce","Meat & Seafood","Dairy","Pantry","Frozen","Bakery"];
  const sortedCats = [...new Set([...catOrder, ...Object.keys(cats)])].filter(c => cats[c]);

  const html = sortedCats.map(cat => `
    <div class="category-group">
      <div class="category-name">${cat}</div>
      ${cats[cat].map((ing, idx) => `
        <div class="ingredient-row" style="animation-delay:${idx * 0.04}s">
          <div class="ing-check" onclick="toggleCheck(this)"></div>
          <div class="ing-name">${ing.name}</div>
          ${ing.consolidated ? '<span class="consolidated-badge">merged</span>' : ''}
          ${ing.flagged ? `<span class="allergen-flag">‚ö† ${ing.allergenType}</span>` : ''}
          <div class="ing-qty">${ing.qty}</div>
          <div class="ing-price">$${ing.price.toFixed(2)}</div>
        </div>
      `).join('')}
    </div>
  `).join('');

  document.getElementById('shopping-list').innerHTML = html;
  document.getElementById('item-count').textContent = `${items.length} items`;
}

function toggleCheck(el) {
  el.classList.toggle('checked');
  el.nextElementSibling.classList.toggle('checked-text');
}

function renderFuzzy(matches) {
  const panel = document.getElementById('fuzzy-panel');
  if (matches.length === 0) {
    panel.innerHTML = `<div class="empty-state" style="padding:24px 0;"><div class="emoji" style="font-size:2rem;">‚úì</div><p style="font-size:0.8rem;">No duplicate ingredients found</p></div>`;
    return;
  }
  panel.innerHTML = matches.map(m => `
    <div class="fuzzy-item">
      <span class="fuzzy-score">${m.into[0].score}% match</span>
      <strong>${m.from}</strong>
      <span class="fuzzy-arrow">‚Üí</span>
      merged with <strong>${m.into.map(x=>x.name).join(', ')}</strong>
    </div>
  `).join('');
}

function renderBudget(total, budget, items) {
  document.getElementById('budget-display').style.display = 'block';
  document.getElementById('budget-empty').style.display = 'none';

  const pct = Math.min((total / budget) * 100, 100);
  const bar = document.getElementById('budget-bar');
  bar.style.width = pct + '%';
  bar.classList.toggle('over', total > budget);

  document.getElementById('spent-label').textContent = `$${total.toFixed(2)}`;
  document.getElementById('budget-label').textContent = `$${budget.toFixed(2)}`;

  const catTotals = {};
  items.forEach(i => { catTotals[i.cat] = (catTotals[i.cat] || 0) + i.price; });

  const labels = Object.keys(catTotals);
  const data = Object.values(catTotals);
  const colors = ['#5a7a5e','#8aad8f','#c1633a','#d4a853','#a8c5ac','#e0956a'];

  if (budgetChart) budgetChart.destroy();

  budgetChart = new Chart(document.getElementById('budget-chart'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderWidth: 0,
        hoverOffset: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { font: { family:'DM Sans', size:11 }, color:'#7a7468', boxWidth:12, padding:10 }
        },
        tooltip: { callbacks: { label: ctx => ` $${ctx.parsed.toFixed(2)}` } }
      },
      cutout: '60%',
    }
  });
}

init();
</script>
</body>
</html>
